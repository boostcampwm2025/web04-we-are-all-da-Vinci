name: Lighthouse CI

on:
  pull_request:
    branches: [main, develop]
    paths:
      - "client/**"

jobs:
  lighthouse:
    name: Lighthouse Performance Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        working-directory: client

      - name: Build
        run: pnpm run build
        working-directory: client

      - name: Run Lighthouse CI
        id: lighthouse
        uses: treosh/lighthouse-ci-action@v12
        with:
          uploadArtifacts: true
          temporaryPublicStorage: true
          configPath: ./client/lighthouserc.json

      - name: Post Lighthouse Report to PR
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const results = ${{ steps.lighthouse.outputs.manifest }};
            const links = ${{ steps.lighthouse.outputs.links }};

            if (!results || !links) {
              console.log('No Lighthouse results found');
              return;
            }

            const summary = results.map((result, i) => {
              const url = Object.keys(links)[i];
              const reportUrl = links[url];
              const { performance, accessibility, 'best-practices': bestPractices, seo } = result.summary;
              
              return `| ${url} | ${Math.round(performance * 100)} | ${Math.round(accessibility * 100)} | ${Math.round(bestPractices * 100)} | ${Math.round(seo * 100)} | [Report](${reportUrl}) |`;
            }).join('\n');

            const body = `## ğŸš€ Lighthouse Report

            | URL | Performance | Accessibility | Best Practices | SEO | Report |
            |-----|-------------|---------------|----------------|-----|--------|
            ${summary}

            > Score legend: ğŸŸ¢ 90-100 | ğŸŸ  50-89 | ğŸ”´ 0-49`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
